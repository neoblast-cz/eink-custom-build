<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Habits Check-in</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --card: #22263a;
      --accent: #e94560;
      --accent-hover: #ff6b81;
      --text: #e8e8e8;
      --muted: #8b8fa3;
      --border: #2a2e42;
      --success: #2ecc71;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 1rem;
      max-width: 480px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .header h1 { font-size: 1.4rem; margin-bottom: 0.3rem; }
    .header .date { color: var(--muted); font-size: 0.95rem; }
    .day-nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }
    .day-nav button {
      background: var(--surface);
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    .day-nav button:hover { color: var(--text); border-color: var(--muted); }
    .day-nav .current-date { font-size: 1.1rem; font-weight: 600; min-width: 140px; text-align: center; }
    .habit-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1rem 1.2rem;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .habit-item:active { transform: scale(0.98); }
    .habit-item.done {
      border-color: var(--success);
      background: #1a2e1f;
    }
    .habit-name { font-size: 1.1rem; font-weight: 500; }
    .habit-check {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .habit-item.done .habit-check {
      background: var(--success);
      border-color: var(--success);
    }
    .habit-check::after {
      content: '';
      display: none;
      width: 10px;
      height: 16px;
      border: solid white;
      border-width: 0 3px 3px 0;
      transform: rotate(45deg) translate(-1px, -1px);
    }
    .habit-item.done .habit-check::after { display: block; }
    .summary {
      text-align: center;
      margin-top: 1.5rem;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .summary .count { color: var(--success); font-weight: 600; font-size: 1.1rem; }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 1.5rem;
      color: var(--muted);
      font-size: 0.85rem;
      text-decoration: none;
    }
    .back-link:hover { color: var(--text); }
    .empty { text-align: center; color: var(--muted); padding: 2rem 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Habits</h1>
  </div>

  <div class="day-nav">
    <button onclick="changeDay(-1)">&larr;</button>
    <span class="current-date" id="dateLabel"></span>
    <button onclick="changeDay(1)">&rarr;</button>
  </div>

  <div id="habitList"></div>
  <div class="summary" id="summary"></div>
  <a href="/" class="back-link">Back to Dashboard</a>

<script>
let habits = [];
let log = {};
let currentDate = new Date();
// Reset to today at midnight
currentDate.setHours(0, 0, 0, 0);

function formatDate(d) {
  return d.toISOString().split('T')[0];
}

function formatDisplay(d) {
  const today = new Date(); today.setHours(0,0,0,0);
  const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
  if (formatDate(d) === formatDate(today)) return 'Today';
  if (formatDate(d) === formatDate(yesterday)) return 'Yesterday';
  return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}

function changeDay(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  // Don't go into the future
  const today = new Date(); today.setHours(0,0,0,0);
  if (currentDate > today) currentDate = today;
  renderList();
}

function loadData() {
  fetch('/habits/data')
    .then(r => r.json())
    .then(data => {
      habits = data.habits || [];
      log = data.log || {};
      renderList();
    });
}

function renderList() {
  const dateStr = formatDate(currentDate);
  document.getElementById('dateLabel').textContent = formatDisplay(currentDate);

  const list = document.getElementById('habitList');
  if (habits.length === 0) {
    list.innerHTML = '<div class="empty">No habits configured.<br>Add them in the settings page.</div>';
    document.getElementById('summary').innerHTML = '';
    return;
  }

  const dayLog = log[dateStr] || {};
  let doneCount = 0;

  list.innerHTML = '';
  habits.forEach(h => {
    const done = dayLog[h.name] === true;
    if (done) doneCount++;

    const div = document.createElement('div');
    div.className = 'habit-item' + (done ? ' done' : '');
    div.innerHTML = `
      <span class="habit-name">${h.name}</span>
      <div class="habit-check"></div>
    `;
    div.onclick = () => toggleHabit(h.name, dateStr, !done);
    list.appendChild(div);
  });

  document.getElementById('summary').innerHTML =
    `<span class="count">${doneCount}/${habits.length}</span> completed`;
}

function toggleHabit(name, dateStr, done) {
  // Optimistic update
  if (!log[dateStr]) log[dateStr] = {};
  log[dateStr][name] = done;
  renderList();

  fetch('/habits/check', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({habit: name, date: dateStr, done: done})
  });
}

loadData();
</script>
</body>
</html>
