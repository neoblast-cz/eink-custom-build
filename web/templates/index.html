{% extends "base.html" %}
{% block content %}
<div class="dashboard">
  <section class="preview-panel">
    <h2>Current Display</h2>
    <div class="preview-frame">
      <img src="/preview" alt="Display preview" class="display-preview" id="previewImg">
    </div>
    <button class="btn-primary" id="refreshBtn" onclick="doRefresh()">Refresh Now</button>

    <!-- Settings toggle -->
    <div class="settings-toggle" onclick="toggleSettings()">
      <span id="settingsArrow">&#9654;</span> Settings
    </div>
    <div id="settingsPanel" class="settings-collapsible" style="display: none;">
      <form method="POST" action="/settings" class="settings-form">
        <h3>Module Rotation</h3>
        <p class="hint">Add modules to rotate between them. Each module displays for its own duration before switching.</p>

        <div id="rotationList">
          {% for entry in rotation %}
          <div class="rotation-entry">
            <select name="rotation_module">
              {% for name, module in modules.items() %}
              <option value="{{ name }}" {% if name == entry.module %}selected{% endif %}>
                {{ module.DISPLAY_NAME }}
              </option>
              {% endfor %}
            </select>
            <input type="number" name="rotation_duration" value="{{ entry.duration_minutes }}" min="1" max="1440" style="width: 80px;">
            <span class="hint" style="margin: 0;">min</span>
            <button type="button" class="btn-danger" onclick="this.parentElement.remove()">Remove</button>
          </div>
          {% endfor %}
        </div>

        <button type="button" class="btn-secondary" onclick="addRotationEntry()" style="margin-top: 0.5rem;">+ Add Module</button>

        <hr>

        <label for="refresh_minutes">Fallback Refresh Interval (minutes)</label>
        <input type="number" id="refresh_minutes" name="refresh_minutes"
               value="{{ config.refresh_minutes }}" min="1" max="1440">
        <p class="hint">Used when only one module is in rotation (no cycling).</p>

        <hr>

        <label for="timezone">Time Zone</label>
        <select id="timezone" name="timezone">
          {% for tz_name in timezones %}
          <option value="{{ tz_name }}" {{ 'selected' if tz_name == config.timezone else '' }}>{{ tz_name }}</option>
          {% endfor %}
        </select>
        <p class="hint">Used for calendar events, tasks, and dashboard times.</p>

        <hr>

        <h3>Google API</h3>
        <p class="hint">Shared credentials for Tasks and Habits modules. Create an OAuth 2.0 Client ID in your <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a>.</p>
        <p class="hint">Add these redirect URIs:<br>
          <code>http://{{ request.host }}/oauth/google/callback</code><br>
          <code>http://{{ request.host }}/oauth/google/sheets/callback</code>
        </p>

        <label for="google_client_id">Client ID</label>
        <input type="text" id="google_client_id" name="google_client_id"
               value="{{ config.google_client_id }}"
               placeholder="xxxx.apps.googleusercontent.com">

        <label for="google_client_secret">Client Secret</label>
        <input type="password" id="google_client_secret" name="google_client_secret"
               value="{{ config.google_client_secret }}"
               placeholder="GOCSPX-...">

        <div class="form-actions">
          <button type="submit" class="btn-primary">Save Settings</button>
        </div>
      </form>
    </div>
  </section>

  <section class="module-panel">
    <h3>Modules</h3>
    <div class="module-list">
      {% for name, module in modules.items() %}
      <div class="module-card" id="card-{{ name }}" data-module="{{ name }}">
        <div class="module-info">
          <strong>{{ module.DISPLAY_NAME }}</strong>
          <p>{{ module.DESCRIPTION }}</p>
        </div>
        <div class="module-actions">
          <button class="btn-preview" onclick="previewModule('{{ name }}')" title="Preview without pushing to display">Preview</button>
          <a href="/module/{{ name }}" class="btn-secondary">Configure</a>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
</div>

<template id="rotationTemplate">
  <div class="rotation-entry">
    <select name="rotation_module">
      {% for name, module in modules.items() %}
      <option value="{{ name }}">{{ module.DISPLAY_NAME }}</option>
      {% endfor %}
    </select>
    <input type="number" name="rotation_duration" value="5" min="1" max="1440" style="width: 80px;">
    <span class="hint" style="margin: 0;">min</span>
    <button type="button" class="btn-danger" onclick="this.parentElement.remove()">Remove</button>
  </div>
</template>

<script>
let currentModule = null;

function previewModule(name) {
  const btn = event.target;
  btn.textContent = '...';
  fetch('/preview_module/' + name, { method: 'POST' })
    .then(res => res.json())
    .then(data => {
      btn.textContent = 'Preview';
      if (data.status === 'ok') {
        document.getElementById('previewImg').src = '/preview?' + Date.now();
        currentModule = name;
        updateActiveCard();
      } else {
        alert('Preview error: ' + (data.error || 'Unknown'));
      }
    })
    .catch(() => { btn.textContent = 'Preview'; alert('Preview request failed'); });
}

function doRefresh() {
  const btn = document.getElementById('refreshBtn');
  btn.textContent = 'Refreshing...';
  btn.disabled = true;

  if (currentModule) {
    // Refresh the currently previewed module
    fetch('/preview_module/' + currentModule, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        setTimeout(() => {
          document.getElementById('previewImg').src = '/preview?' + Date.now();
          btn.textContent = 'Refresh Now';
          btn.disabled = false;
        }, 500);
      })
      .catch(() => { btn.textContent = 'Refresh Now'; btn.disabled = false; });
  } else {
    // No module previewed yet, trigger scheduler refresh
    fetch('/refresh', { method: 'POST' })
      .then(() => {
        setTimeout(() => {
          document.getElementById('previewImg').src = '/preview?' + Date.now();
          btn.textContent = 'Refresh Now';
          btn.disabled = false;
        }, 2000);
      })
      .catch(() => { btn.textContent = 'Refresh Now'; btn.disabled = false; });
  }
}

function updateActiveCard() {
  document.querySelectorAll('.module-card').forEach(card => {
    card.classList.toggle('active', card.dataset.module === currentModule);
  });
}

function toggleSettings() {
  const panel = document.getElementById('settingsPanel');
  const arrow = document.getElementById('settingsArrow');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    arrow.innerHTML = '&#9660;';
  } else {
    panel.style.display = 'none';
    arrow.innerHTML = '&#9654;';
  }
}

function addRotationEntry() {
  const tmpl = document.getElementById('rotationTemplate');
  const clone = tmpl.content.cloneNode(true);
  document.getElementById('rotationList').appendChild(clone);
}

// Auto-refresh preview every 30s
setInterval(() => {
  document.getElementById('previewImg').src = '/preview?' + Date.now();
}, 30000);
</script>
{% endblock %}
